"use strict";const vmUpdateFunctionKeyPrefix="vitraux-vms-";class VitrauxInternalError extends Error{constructor(e){super(`Vitraux Internal Error: ${e}`)}}globalThis.vitraux={config:{useShadowDom:!0,configure(e){this.useShadowDom=e}},storedElements:{elements:{},getElementByIdAsArray(e){const t=document.getElementById(e);return t?[t]:[]},getStoredElementByIdAsArray(e,t){return this.elements[t]??this.storeElementByIdAsArray(e,t)},storeElementByIdAsArray(e,t){const n=this.getElementByIdAsArray(e);return this.elements[t]=n,n},getElementsByQuerySelector:(e,t)=>e.querySelectorAll(t),getStoredElementsByQuerySelector(e,t,n){return this.elements[n]??this.storeElementsByQuerySelector(e,t,n)},storeElementsByQuerySelector(e,t,n){const o=this.getElementsByQuerySelector(e,t);return this.elements[n]=o,o},getTemplate(e){return this.trimTemplateContent(document.getElementById(e)?.content)},getStoredTemplate(e,t){return this.elements[t]??this.storeTemplate(e,t)},storeTemplate(e,t){const n=this.getTemplate(e);return this.elements[t]=n,n},async fetchElement(e){const t=await fetch(e),n=await t.text(),o=document.createElement("template");return o.innerHTML=n.trim(),this.trimTemplateContent(o?.content)},async getFetchedElement(e,t){return this.elements[t]??await this.storeFetchedElement(e,t)},async storeFetchedElement(e,t){const n=await this.fetchElement(e);return this.elements[t]=n,n},trimTemplateContent(e){if(!e)return e;for(let t=0;this.tryRemoveEmptyTextNode(e,t);t++);for(let t=e.childNodes.length-1;this.tryRemoveEmptyTextNode(e,t);t--);return e},tryRemoveEmptyTextNode(e,t){const n=e.childNodes[t];return!(!n||n.nodeType!==Node.TEXT_NODE||n.textContent.trim())&&(e.removeChild(n),!0)}},updating:{utils:{isValueValid:e=>e||0===e||!1===e||""===e},vmFunctions:{vms:[],async executeInitializationView(e){const t=new Function(e);await t()},async executeUpdateViewFunctionFromJson(e,t){const n=JSON.parse(t);await this.executeUpdateViewFunction(e,n)},async executeUpdateViewFunction(e,t){const n=this.vms[e];await n(t)},getFullVMKey:e=>"vitraux-vms-"+e,getFunctionsCodeFromVersion(e,t){if(!e||!t)throw new VitrauxInternalError("vmKey and version must be set in isVersionedUpdateViewFunctionRegenerationNeeded!");const n=localStorage.getItem(this.getFullVMKey(e));if(!n)return!1;const o=JSON.parse(n);return o.version===t&&o},async tryInitializeViewFunctionsFromCacheByVersion(e,t){if(!t)throw new VitrauxInternalError("Version must be set in tryInitializeViewFunctionsFromCacheByVersion!");const n=this.getFunctionsCodeFromVersion(e,t);return!!n&&(await this.executeInitializationView(n.initializationCode),this.createUpdateViewFunction(e,n.updateViewCode),!0)},async initializeNewViewFunctionsToCacheByVersion(e,t,n,o){if(!t)throw new VitrauxInternalError("Version must be set in initializeNewViewFunctionsToCacheByVersion!");await this.executeInitializationView(n),this.createUpdateViewFunction(e,o),this.storeFunctions(e,t,n,o)},async initializeNonCachedViewFunctions(e,t,n){await this.executeInitializationView(t),this.createUpdateViewFunction(e,n)},createUpdateViewFunction(e,t){var n="return (async () => {"+t+"})()";this.vms[e]=new Function("vm",n)},storeFunctions(e,t,n,o){const i={initializationCode:n,updateViewCode:o,version:t};localStorage.setItem(this.getFullVMKey(e),JSON.stringify(i))}},dom:{setElementsContent(e,t){for(const n of e)n.textContent=t},setElementsHtml(e,t){for(const n of e)n.innerHTML=t},setElementsAttribute(e,t,n){("boolean"==typeof n?this.toggleBoolAttribute:this.setAttributeValue)(e,t,n)},setAttributeValue(e,t,n){for(const o of e)o.setAttribute(t,n)},toggleBoolAttribute(e,t,n){for(const o of e)o.toggleAttribute(t,n)},updateValueByInsertingElements(e,t,n,o){if(e)for(const i of t){const t=e.cloneNode(!0);o(n(t)),this.appendOnlyChild(i,t)}},async updateTable(e,t,n,o,i){for(const r of e){const e=document.createElement("tbody");for(const t of i)await this.addNewRow(e,n,o,t);r.tBodies[t].replaceWith(e)}},async updateCollectionByPopulatingElements(e,t,n,o){for(const i of e){const e=[];for(const i of o){const o=await this.updateCollectionElement(t,n,i);e.push(o)}this.replaceChildren(i,e)}},async addNewRow(e,t,n,o){const i=await this.updateCollectionElement(t,n,o);e.appendChild(i)},async updateCollectionElement(e,t,n){const o=e.cloneNode(!0);return await t(o,n),o},replaceChildren(e,t){this.tryAttachShadow(e).replaceChildren(...t)},appendOnlyChild(e,t){this.replaceChildren(e,[t])},tryAttachShadow(e){return this.supportShadowDom(e)?this.getAttachedShadow(e):e},getAttachedShadow:e=>e.shadowRoot?e.shadowRoot:e.attachShadow({mode:"open"}),supportShadowDom(e){if(!globalThis.vitraux.config.useShadowDom)return!1;if(!e||e.nodeType!==Node.ELEMENT_NODE)return!1;if(e.shadowRoot)return!0;const t=new Set(["article","aside","blockquote","body","div","footer","h1","h2","h3","h4","h5","h6","header","main","nav","p","section","span"]),n=e.tagName.toLowerCase();return t.has(n)||n.includes("-")&&customElements.get(n)}}}};