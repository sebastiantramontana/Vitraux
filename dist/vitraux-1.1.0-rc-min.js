"use strict";const vmUpdateFunctionKeyPrefix="vitraux-vms-";class VitrauxInternalError extends Error{constructor(t){super(`Vitraux Internal Error: ${t}`)}}class VitrauxWasm{static#t;async getExports(){if(!VitrauxWasm.#t){const t=await globalThis.getDotnetRuntime(0);VitrauxWasm.#t=await t("Vitraux.dll")}return VitrauxWasm.#t}}class ActionDispatcher{#e;#i;#n;constructor(t,e,i){this.#e=t,this.#i=e,this.#n=i}async dispatchActionSync(){(await this.#n.getExports()).DispatchAction(this.#e,this.#i)}async dispatchActionAsync(){const t=await this.#n.getExports();await t.DispatchAction(this.#e,this.#i)}}class ParametrizableActionDispatcher{#e;#i;#s;#n;constructor(t,e,i,n){this.#e=t,this.#i=e,this.#s=i,this.#n=n}async dispatchParametrizableActionSync(t){const e=this.#s.call(null,t);(await this.#n.getExports()).DispatchParametrizableAction(this.#e,this.#i,e)}async dispatchParametrizableActionAsync(t){const e=this.#s.call(null,t),i=await this.#n.getExports();await i.DispatchParametrizableActionAsync(this.#e,this.#i,e)}}class ActionListenerSync{#o;constructor(t){this.#o=t}async handleEvent(){await this.#o.dispatchActionSync()}}class ActionListenerAsync{#o;constructor(t){this.#o=t}async handleEvent(){await this.#o.dispatchActionAsync()}}class ParametrizableActionListenerSync{#o;constructor(t){this.#o=t}async handleEvent(t){await this.#o.dispatchParametrizableActionSync(t)}}class ParametrizableActionListenerAsync{#o;constructor(t){this.#o=t}async handleEvent(t){await this.#o.dispatchParametrizableActionAsync(t)}}globalThis.vitraux={config:{useShadowDom:!0,configure(t){this.useShadowDom=t}},getFullVMKey:t=>"vitraux-vms-"+t,storedElements:{elements:{},getElementByIdAsArray(t){const e=document.getElementById(t);return e?[e]:[]},getStoredElementByIdAsArray(t,e){return this.elements[e]??this.storeElementByIdAsArray(t,e)},storeElementByIdAsArray(t,e){const i=this.getElementByIdAsArray(t);return this.elements[e]=i,i},getElementsByQuerySelector:(t,e)=>t.querySelectorAll(e),getStoredElementsByQuerySelector(t,e,i){return this.elements[i]??this.storeElementsByQuerySelector(t,e,i)},storeElementsByQuerySelector(t,e,i){const n=this.getElementsByQuerySelector(t,e);return this.elements[i]=n,n},getTemplate(t){return this.trimTemplateContent(document.getElementById(t)?.content)},getStoredTemplate(t,e){return this.elements[e]??this.storeTemplate(t,e)},storeTemplate(t,e){const i=this.getTemplate(t);return this.elements[e]=i,i},async fetchElement(t){const e=await fetch(t),i=await e.text(),n=document.createElement("template");return n.innerHTML=i.trim(),this.trimTemplateContent(n?.content)},async getFetchedElement(t,e){return this.elements[e]??await this.storeFetchedElement(t,e)},async storeFetchedElement(t,e){const i=await this.fetchElement(t);return this.elements[e]=i,i},trimTemplateContent(t){if(!t)return t;for(let e=0;this.tryRemoveEmptyTextNode(t,e);e++);for(let e=t.childNodes.length-1;this.tryRemoveEmptyTextNode(t,e);e--);return t},tryRemoveEmptyTextNode(t,e){const i=t.childNodes[e];return!(!i||i.nodeType!==Node.TEXT_NODE||i.textContent.trim())&&(t.removeChild(i),!0)}},updating:{utils:{isValueValid:t=>t||0===t||!1===t||""===t},vmFunctions:{vms:[],async executeInitializationView(t){const e=new Function(t);await e()},async executeUpdateViewFunctionFromJson(t,e){const i=JSON.parse(e);await this.executeUpdateViewFunction(t,i)},async executeUpdateViewFunction(t,e){const i=this.vms[t];await i(e)},getFunctionsCodeFromVersion(t,e){if(!t||!e)throw new VitrauxInternalError("vmKey and version must be set in getFunctionsCodeFromVersion!");const i=localStorage.getItem(globalThis.vitraux.getFullVMKey(t));if(!i)return!1;const n=JSON.parse(i);return n.version===e&&n},async tryInitializeViewFunctionsFromCacheByVersion(t,e){if(!e)throw new VitrauxInternalError("Version must be set in tryInitializeViewFunctionsFromCacheByVersion!");const i=this.getFunctionsCodeFromVersion(t,e);return!!i&&(await this.executeInitializationView(i.initializationCode),this.createUpdateViewFunction(t,i.updateViewCode),!0)},async initializeNewViewFunctionsToCacheByVersion(t,e,i,n){if(!e)throw new VitrauxInternalError("Version must be set in initializeNewViewFunctionsToCacheByVersion!");await this.executeInitializationView(i),this.createUpdateViewFunction(t,n),this.storeFunctions(t,e,i,n)},async initializeNonCachedViewFunctions(t,e,i){await this.executeInitializationView(e),this.createUpdateViewFunction(t,i)},createUpdateViewFunction(t,e){var i="return (async () => {"+e+"})()";this.vms[t]=new Function("vm",i)},storeFunctions(t,e,i,n){const s={initializationCode:i,updateViewCode:n,version:e};localStorage.setItem(globalThis.vitraux.getFullVMKey(t),JSON.stringify(s))}},dom:{setElementsContent(t,e){for(const i of t)i.textContent=e},setElementsHtml(t,e){for(const i of t)i.innerHTML=e},setElementsAttribute(t,e,i){("boolean"==typeof i?this.toggleBoolAttribute:this.setAttributeValue)(t,e,i)},setAttributeValue(t,e,i){for(const n of t)n.setAttribute(e,i)},toggleBoolAttribute(t,e,i){for(const n of t)n.toggleAttribute(e,i)},updateValueByInsertingElements(t,e,i,n){if(t)for(const s of e){const e=t.cloneNode(!0);n(i(e)),this.appendOnlyChild(s,e)}},async updateTable(t,e,i,n,s){for(const o of t){const t=document.createElement("tbody");for(const e of s)await this.addNewRow(t,i,n,e);o.tBodies[e].replaceWith(t)}},async updateCollectionByPopulatingElements(t,e,i,n){for(const s of t){const t=[];for(const s of n){const n=await this.updateCollectionElement(e,i,s);t.push(n)}this.replaceChildren(s,t)}},async addNewRow(t,e,i,n){const s=await this.updateCollectionElement(e,i,n);t.appendChild(s)},async updateCollectionElement(t,e,i){const n=t.cloneNode(!0);return await e(n,i),n},replaceChildren(t,e){this.tryAttachShadow(t).replaceChildren(...e)},appendOnlyChild(t,e){this.replaceChildren(t,[e])},tryAttachShadow(t){return this.supportShadowDom(t)?this.getAttachedShadow(t):t},getAttachedShadow:t=>t.shadowRoot?t.shadowRoot:t.attachShadow({mode:"open"}),supportShadowDom(t){if(!globalThis.vitraux.config.useShadowDom)return!1;if(!t||t.nodeType!==Node.ELEMENT_NODE)return!1;if(t.shadowRoot)return!0;const e=new Set(["article","aside","blockquote","body","div","footer","h1","h2","h3","h4","h5","h6","header","main","nav","p","section","span"]),i=t.tagName.toLowerCase();return e.has(i)||i.includes("-")&&customElements.get(i)}}},actions:{dom:{getElementsContent:t=>t.map(t=>t.textContent),getElementsAttribute:(t,e)=>t.map(t=>function(t,e){const i=t.getAttribute(e);return e===i||i}(t,e)),getInputsValue:t=>t.map(t=>t.value)},registration:{vmActions:[],actionRegistrationStrategy:Object.freeze({OnlyOnceAtStart:"OnlyOnceAtStart",OnlyOnceOnDemand:"OnlyOnceOnFirstViewModelRendering",Always:"AlwaysOnViewModelRendering"}),getActionFullVMCacheKey:t=>`${globalThis.vitraux.getFullVMKey(t)}-actions`,executeActionRegistrationsCode(t){new Function(t)()},createActionRegistrationsFunction(t,e){this.vmActions[t]=new Function(e)},executeActionRegistrationsFunction(t){(0,this.vmActions[t])()},registerActionSync(t,e,i,n){this.addActionListenerToElements(t,e,new ActionListenerSync(new ActionDispatcher(i,n,new VitrauxWasm)))},registerActionAsync(t,e,i,n){this.addActionListenerToElements(t,e,new ActionListenerAsync(new ActionDispatcher(i,n,new VitrauxWasm)))},registerParametrizableActionSync(t,e,i,n,s){this.addActionListenerToElements(t,e,new ParametrizableActionListenerSync(new ParametrizableActionDispatcher(i,n,s,new VitrauxWasm)))},registerParametrizableActionAsync(t,e,i,n,s){this.addActionListenerToElements(t,e,new ParametrizableActionListenerAsync(new ParametrizableActionDispatcher(i,n,s,new VitrauxWasm)))},addActionListenerToElements(t,e,i){for(const n of t)for(const t of e)n.addEventListener(t,i)},getActionFunctionCodeFromVersion(t,e){if(!t||!e)throw new VitrauxInternalError("vmKey and version must be set in getActionFunctionCodeFromVersion!");const i=localStorage.getItem(t);if(!i)return!1;const n=JSON.parse(i);return n.version===e&&n},storeActionsFunction(t,e,i,n){const s={actionsCode:i,actionRegistrationStrategy:n,version:e};localStorage.setItem(t,JSON.stringify(s))},tryInitializeActionsFunctionFromCacheByVersion(t,e){if(!t||!e)throw new VitrauxInternalError("Version must be set in tryInitializeActionsFunctionFromCacheByVersion!");const i=this.getActionFullVMCacheKey(t),n=this.getActionFunctionCodeFromVersion(i,e);return!!n&&(this.initializeActionRegistrationsByActionRegistrationStrategy(t,n.actionsCode,n.actionRegistrationStrategy),!0)},initializeNonCachedActionsFunction(t,e,i){this.initializeActionRegistrationsByActionRegistrationStrategy(t,e,i)},initializeNewActionsFunctionToCacheByVersion(t,e,i,n){if(!t||!e)throw new VitrauxInternalError("Version must be set in initializeNewActionsFunctionToCacheByVersion!");this.initializeActionRegistrationsByActionRegistrationStrategy(t,i,n);const s=this.getActionFullVMCacheKey(t);this.storeActionsFunction(s,e,i,n)},initializeActionRegistrationsByActionRegistrationStrategy(t,e,i){i===this.actionRegistrationStrategy.OnlyOnceAtStart?this.executeActionRegistrationsCode(e):this.createActionRegistrationsFunction(t,e)}}}};